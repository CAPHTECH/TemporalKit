# TemporalKit 概要

TemporalKitは、Swiftで書かれた形式的検証ライブラリで、特に線形時相論理（LTL）を用いたモデル検査に焦点を当てています。このライブラリを使用すると、iOSアプリケーションの状態遷移、ユーザーフロー、並行処理などの時間的な振る舞いを形式的に検証できます。

## TemporalKitとは？

TemporalKitは、アプリケーションの動作が期待通りであることを数学的に保証するための強力なツールです。従来のテストがアプリケーションの特定の入力と実行パスをチェックするのに対し、形式的検証はすべての可能な実行パスを網羅的に検証します。

TemporalKitの主な特徴：

- **線形時相論理（LTL）のサポート**: 時間の経過に伴うシステムの振る舞いを記述するための形式言語
- **モデル検査機能**: システムモデルがLTL式を満たすかどうかを自動的に検証
- **Swiftネイティブ**: Swift言語で実装され、Swiftのタイプシステムを活用
- **iOS/macOS互換**: Apple開発エコシステムとシームレスに統合
- **DSL**: 直感的なLTL式を書くための領域特化言語

## 形式的検証とその重要性

形式的検証は、ソフトウェアが仕様を満たしていることを数学的に証明するプロセスです。従来のテスト手法とは異なり、形式的検証はすべての可能な入力と実行パスを考慮し、特定の条件下でシステムが特定のプロパティを必ず満たすことを保証します。

形式的検証が重要な理由：

1. **網羅的なチェック**: すべての可能な実行パスを検証
2. **バグの早期発見**: 複雑な並行処理バグなど、テストでは発見しにくい問題を特定
3. **自動検証**: 一度モデルを定義すれば、多くのプロパティを自動的に検証可能
4. **正当性の保証**: システムが常に期待通りに動作することを保証

## 線形時相論理（LTL）とは

線形時相論理は、時間の経過に伴うシステムの動作を記述するための形式言語です。LTLは「常に」、「いつか」、「次に」などの時間的演算子を使用して、実行パス上でプロパティが成り立つかどうかを指定します。

基本的なLTL演算子：

- **Next (X)**: 次の状態でプロパティが成り立つ
- **Eventually (F)**: いつかプロパティが成り立つ
- **Globally (G)**: 常にプロパティが成り立つ
- **Until (U)**: あるプロパティが成り立つまで、別のプロパティが成り立ち続ける

TemporalKitでのLTL式の例：

```swift
// 「リクエストの後、いつかレスポンスが来る」
let requestResponseProperty = G(.implies(.atomic(request), F(.atomic(response))))

// 「クリティカルセクションには一度に1つのプロセスのみアクセス可能」
let mutualExclusionProperty = G(.not(.and(.atomic(process1InCS), .atomic(process2InCS))))
```

## モデル検査の概要

モデル検査は、有限状態システムがLTL式で表現された仕様を満たすかどうかを自動的に検証するプロセスです。モデル検査器は、システムのすべての可能な状態と遷移を探索し、指定されたプロパティが満たされるかどうかを確認します。

モデル検査のステップ：

1. **システムのモデル化**: システムの状態と遷移を表すクリプケ構造を定義
2. **プロパティの指定**: 検証したいプロパティをLTL式で表現
3. **検証の実行**: モデル検査アルゴリズムを使用してプロパティを検証
4. **結果の分析**: プロパティが成立する場合は確認、そうでない場合は反例を分析

## TemporalKitの使用例

TemporalKitは、以下のようなiOSアプリケーション開発の様々な側面で活用できます：

### 状態管理の検証

複雑な状態管理を持つアプリでは、すべての状態遷移が有効であり、不正な状態に陥らないことを検証できます。

```swift
// ユーザー認証状態を検証する例
enum AuthState { case loggedOut, loggingIn, loggedIn, error }

// プロパティ例: 「エラー状態からは必ずログアウト状態に戻れる」
let errorRecoveryProperty = G(.implies(.atomic(isError), F(.atomic(isLoggedOut))))
```

### ユーザーフローの検証

オンボーディング、チェックアウトなどの複雑なユーザーフローを検証できます。

```swift
// チェックアウトフローのプロパティ例
// 「支払いが成功したら、最終的に注文確認画面に到達する」
let paymentSuccessProperty = G(.implies(
    .and(.atomic(isPaymentScreen), .atomic(isPaymentSuccessful)),
    F(.atomic(isOrderConfirmationScreen))
))
```

### 並行処理の検証

複数のスレッドやタスクが相互作用するシステムで、デッドロックやレースコンディションがないことを検証できます。

```swift
// 並行処理のプロパティ例
// 「共有リソースは一度に1つのスレッドのみアクセス可能」
let mutexProperty = G(.not(.and(.atomic(thread1AccessingResource), .atomic(thread2AccessingResource))))
```

### ネットワーク処理の検証

リトライロジック、タイムアウト処理、キャッシュ戦略などを検証できます。

```swift
// ネットワークリクエストのプロパティ例
// 「リクエストが失敗したら、最大3回までリトライする」
let retryProperty = G(.implies(.atomic(isRequestFailed), X(.or(
    .atomic(isRetrying),
    .atomic(isMaxRetriesReached)
))))
```

## 既存のプロジェクトへの統合

TemporalKitは、既存のiOSプロジェクトに簡単に統合できます。Swift Package Managerを使用して依存関係を追加し、アプリケーションの重要な部分のモデルを作成することで、形式的検証の恩恵を受けることができます。

主な統合ポイント：

1. **状態管理ライブラリとの連携**: SwiftUIのState、Redux、The Composable Architectureなどと統合
2. **テストスイートの拡張**: 単体テスト、UIテストと合わせて形式的検証を実施
3. **CI/CDパイプラインへの組み込み**: 継続的な検証プロセスの一部として形式的検証を自動化

## まとめ

TemporalKitは、Swiftアプリケーション開発における形式的検証の導入を容易にするライブラリです。線形時相論理（LTL）とモデル検査を活用することで、テストだけでは発見が難しいバグを防ぎ、アプリケーションの動作が常に仕様を満たすことを保証します。

複雑な状態遷移、ユーザーフロー、並行処理などが関わるアプリケーションでは、TemporalKitを使用することで、より堅牢で信頼性の高いソフトウェアを開発することができます。

次のステップとして、[インストールガイド](./Installation.md)に進み、プロジェクトへのTemporalKitの追加方法を学びましょう。また、[チュートリアル](./Tutorials/README.md)セクションでは、具体的な使用例と実装パターンを見ることができます。 
